(window.webpackJsonp=window.webpackJsonp||[]).push([[792],{2118:function(t,e,a){"use strict";a.r(e);var s=a(36),n=Object(s.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"content-delivery-server-for-multitenancy"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#content-delivery-server-for-multitenancy"}},[t._v("#")]),t._v(" Content Delivery Server for Multitenancy")]),t._v(" "),a("p",[t._v("An Entando Content Delivery Server (CDS) is required in order to enable multiple tenants to be served by the same Entando Application. This tutorial describes the steps required to setup CDS and configure the Entando App Engine to use it.")]),t._v(" "),a("h2",{attrs:{id:"prerequisites"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#prerequisites"}},[t._v("#")]),t._v(" Prerequisites")]),t._v(" "),a("ul",[a("li",[a("RouterLink",{attrs:{to:"/v7.2/docs/getting-started/"}},[t._v("A working instance of Entando")]),t._v(" based on the default Tomcat server image")],1)]),t._v(" "),a("h2",{attrs:{id:"create-the-cds-resources"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-the-cds-resources"}},[t._v("#")]),t._v(" Create the CDS Resources")]),t._v(" "),a("p",[t._v("A set of resources are necessary to separate the storage and user data for the primary and each secondary tenant. For secondary tenants, simply provide a new tenant identifier referred to as "),a("code",[t._v("YOUR-TENANT-NAME")]),t._v(".")]),t._v(" "),a("ol",[a("li",[t._v("Log in to the Keycloak admin console and get the RSA key for your realm by going to "),a("code",[t._v("Realm Settings")]),t._v(" â†’ "),a("code",[t._v("Keys")]),t._v(".")]),t._v(" "),a("li",[t._v("Click on "),a("code",[t._v("Public Key")]),t._v(" for "),a("code",[t._v("rsa-generated")]),t._v(" provider and copy the content. This will be "),a("code",[t._v("YOUR-PUBLIC-KEYCLOAK-KEY")]),t._v(" below.")]),t._v(" "),a("li",[t._v("Download the template "),a("code",[t._v("entando-cds.yaml")]),t._v(":")])]),t._v(" "),a("EntandoCode",[t._v('curl -sLO "https://raw.githubusercontent.com/entando/entando-releases/'+t._s(t.$site.themeConfig.entando.fixpack.v72)+'/dist/ge-1-1-6/samples/entando-cds.yaml"')]),t._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[t._v("Replace the placeholders in "),a("code",[t._v("entando-cds.yaml")]),t._v(" with the appropriate values for your environment.")])]),t._v(" "),a("p",[t._v("Conventions:")]),t._v(" "),a("ul",[a("li",[t._v("The storage limit and request is set to 1Gi and can be modified on the persistent volume claim.")]),t._v(" "),a("li",[t._v("The file upload size limit is set to 150m and can be configured via the ingress annotations.")]),t._v(" "),a("li",[t._v("In order to enable TLS, add a TLS secret and configure it on the ingress. Note that public URLs (e.g., "),a("code",[t._v("CDS_PUBLIC_URL")]),t._v(") should use the same "),a("strong",[t._v("http")]),t._v(" or "),a("strong",[t._v("https")]),t._v(" protocol as the Entando Application. Private/cluster-level URLs (e.g., "),a("code",[t._v("CDS_PRIVATE_URL")]),t._v(") should use "),a("strong",[t._v("http")]),t._v(".")]),t._v(" "),a("li",[t._v("The same Keycloak public key can be used if all the tenants share a Keycloak instance using different realms.")])]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("Placeholder")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("Description")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("YOUR-APP-NAME")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("The name of the application, e.g., quickstart")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("YOUR-HOST-NAME")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("The base host name of the application, e.g., your-domain.com")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("YOUR-TENANT-NAME")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("The identifying name of the current tenant. In most cases it will also be used to determine the base URL of the tenant. For example, yoursite results in yoursite.your-domain.com.")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("YOUR-PUBLIC-KEYCLOAK-KEY")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("The public RSA key for the corresponding Keycloak instance. Make sure to retain the wrapping text with linefeeds: "),a("code",[t._v("---BEGIN PUBLIC KEY... END PUBLIC KEY---\\n")]),t._v(".")])])])]),t._v(" "),a("ol",{attrs:{start:"5"}},[a("li",[t._v("Create the CDS resources:")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("kubectl apply -f entando-cds-YOUR-TENANT-NAME.yaml -n YOUR-NAMESPACE\n")])])]),a("h2",{attrs:{id:"configure-the-entandoapp-to-use-cds"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configure-the-entandoapp-to-use-cds"}},[t._v("#")]),t._v(" Configure the EntandoApp to use CDS")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("p",[t._v("The Entando App Engine needs to be reconfigured just for the initial or primary tenant so all tenants use CDS in the same way.")])]),t._v(" "),a("ol",[a("li",[t._v("Scale the EntandoApp deployment down to 0 replicas:")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("kubectl scale deploy/YOUR-APP-NAME-deployment --replicas"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" -n YOUR-NAMESPACE\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("Edit the deployment YAML and add these environment variables:")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" CDS_ENABLED\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" CDS_PUBLIC_URL\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//YOUR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("APP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cds.YOUR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("HOST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("NAME/YOUR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("TENANT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("NAME\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" CDS_PRIVATE_URL\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//YOUR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("TENANT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" CDS_PATH\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /api/v1\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[t._v("Remove the volume and volumeMount which were automatically created by the initial install process:")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /entando"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("data\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" YOUR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("APP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("volume\n")])])]),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" YOUR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("APP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("volume\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("persistentVolumeClaim")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("claimName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" YOUR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("APP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("pvc\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[t._v("Scale the deployment back up to 1 or more replicas:")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("kubectl scale deploy/YOUR-APP-NAME-deployment --replicas"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" -n YOUR-NAMESPACE\n")])])]),a("ol",{attrs:{start:"5"}},[a("li",[t._v("Confirm the CDS is working by checking that digital assets are served from the "),a("code",[t._v("CDS_PUBLIC_URL")]),t._v(". This includes images displayed on the sample page created by the "),a("RouterLink",{attrs:{to:"/v7.2/docs/compose/welcome-wizard.html"}},[t._v("Welcome Wizard")]),t._v(".")],1)])],1)}),[],!1,null,null,null);e.default=n.exports}}]);