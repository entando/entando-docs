(window.webpackJsonp=window.webpackJsonp||[]).push([[654],{1920:function(e,t,a){"use strict";a.r(t);var s=a(36),n=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"role-based-access-controls"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#role-based-access-controls"}},[e._v("#")]),e._v(" Role Based Access Controls")]),e._v(" "),a("h2",{attrs:{id:"overview"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#overview"}},[e._v("#")]),e._v(" Overview")]),e._v(" "),a("p",[e._v("Experts recommend following a practice known as Defense in Depth where security controls are placed in each layer of an architecture. This tutorial guides you through adding access controls to your existing Entando project, in both the frontend and backend of your Entando Application.")]),e._v(" "),a("p",[e._v("The simple Conference application found in the "),a("RouterLink",{attrs:{to:"/v7.0/tutorials/create/ms/generate-microservices-and-micro-frontends.html"}},[e._v("Generate Microservices and Micro Frontends tutorial")]),e._v(" is used as a starting point. We recommend working through that tutorial for background and context.")],1),e._v(" "),a("p",[e._v("The basic security setup for a blueprint-generated application allows any authenticated user to access the functionality contained in the MFEs and/or microservices. This tutorial defines two user roles for our application:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("conference-user")]),e._v(": Permitted to view the Conferences in the tableWidget")]),e._v(" "),a("li",[a("code",[e._v("conference-admin")]),e._v(": Permitted to view Conferences in the tableWidget, and also to delete Conferences from the tableWidget")])]),e._v(" "),a("h2",{attrs:{id:"apply-and-verify-access-controls"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#apply-and-verify-access-controls"}},[e._v("#")]),e._v(" Apply and Verify Access Controls")]),e._v(" "),a("h3",{attrs:{id:"step-1-secure-the-conference-list"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-1-secure-the-conference-list"}},[e._v("#")]),e._v(" Step 1: Secure the Conference list")]),e._v(" "),a("p",[e._v("The list of Conferences must be visible to only the "),a("code",[e._v("conference-user")]),e._v(" and "),a("code",[e._v("conference-admin")]),e._v(" user roles.")]),e._v(" "),a("ol",[a("li",[e._v("Go to the "),a("code",[e._v("src/main/java/com/YOUR-ORG/YOUR-NAME/web/rest")]),e._v(" directory")]),e._v(" "),a("li",[e._v("Open "),a("code",[e._v("ConferenceResource.java")])]),e._v(" "),a("li",[e._v("Add the following to the list of imports:")])]),e._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[e._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[e._v("org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("springframework"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("security"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("access"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("prepost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")])]),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("PreAuthorize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[e._v("Modify the REST API "),a("code",[e._v("Conference:getAllConferences")]),e._v(" method by preceding it with the @PreAuthorize annotation. Your method signature may be different depending on your blueprint selections.")])]),e._v(" "),a("div",{staticClass:"language-java extra-class"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[e._v(" ")]),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[e._v("    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[e._v("@PreAuthorize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("\"hasAnyAuthority('conference-user','conference-admin')\"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("public")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("List")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Conference")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("getAllConferences")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])])]),a("p",[e._v("This confines use of the "),a("code",[e._v("getAllConferences")]),e._v(" method to users who are assigned either the "),a("code",[e._v("conference-user")]),e._v(" or the "),a("code",[e._v("conference-admin")]),e._v(" role on the Keycloak client configured for the microservice.")]),e._v(" "),a("blockquote",[a("p",[e._v("Note: In local testing, the default client is "),a("code",[e._v("internal")]),e._v(". Refer to the "),a("a",{attrs:{href:"https://spring.io/projects/spring-security",target:"_blank",rel:"noopener noreferrer"}},[e._v("Spring Security documentation"),a("OutboundLink")],1),e._v(" for more information.")])]),e._v(" "),a("p",[e._v("We also need to modify the blueprint JWT handling to deal with a recent change to the Spring libraries.")]),e._v(" "),a("ol",{attrs:{start:"5"}},[a("li",[e._v("Edit "),a("code",[e._v("src/main/java/com/mycompany/myapp/config/SecurityConfiguration.java")]),e._v(" and make two changes.")])]),e._v(" "),a("ul",[a("li",[e._v("Add this code after the other @Value fields")])]),e._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[e._v("@Value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"${spring.security.oauth2.client.registration.oidc.client-id}"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("String")]),e._v(" clientId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("ul",[a("li",[e._v("Modify the following call in the "),a("code",[e._v("authenticationConverter")]),e._v(" method to provide the clientId field")])]),e._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[e._v("jwtAuthenticationConverter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("setJwtGrantedAuthoritiesConverter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("JwtGrantedAuthorityConverter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("clientId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("ol",{attrs:{start:"6"}},[a("li",[e._v("Now modify"),a("br"),e._v(" "),a("code",[e._v("src/main/java/com/mycompany/myapp/security/oauth2/JwtGrantedAuthorityConverter.java")]),e._v(" to accept the clientId. Three changes are required.")])]),e._v(" "),a("ul",[a("li",[e._v("Remove the @Component annotation on the class definition")])]),e._v(" "),a("div",{staticClass:"language-java extra-class"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[e._v(" ")]),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[e._v("@Component")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("public")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("class")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("JwtGrantedAuthorityConverter")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("implements")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Converter")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Jwt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Collection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("GrantedAuthority")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n")])])]),a("ul",[a("li",[e._v("Remove the @Value annotation on the clientId field")])]),e._v(" "),a("div",{staticClass:"language-java extra-class"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[e._v(" ")]),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[e._v("@Value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"${spring.security.oauth2.client.registration.oidc.client-id}"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("String")]),e._v(" clientId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("ul",[a("li",[e._v("Modify the constructor to accept the clientId")])]),e._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[e._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("public")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("JwtGrantedAuthorityConverter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("String")]),e._v(" clientId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("clientId "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" clientId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),a("h3",{attrs:{id:"step-2-run-your-project-in-a-local-developer-environment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-2-run-your-project-in-a-local-developer-environment"}},[e._v("#")]),e._v(" Step 2: Run your project in a local developer environment")]),e._v(" "),a("p",[e._v("The following commands must be run from your project directory. They leverage the "),a("RouterLink",{attrs:{to:"/v7.0/docs/reference/entando-cli.html"}},[e._v("ent CLI")]),e._v(".")],1),e._v(" "),a("blockquote",[a("p",[e._v("Note: Refer to the "),a("RouterLink",{attrs:{to:"/v7.0/tutorials/create/ms/run-local.html"}},[e._v("Run Blueprint-generated Microservices and Micro Frontends in Dev Mode tutorial")]),e._v(" for details.")],1)]),e._v(" "),a("ol",[a("li",[e._v("Start up your Keycloak instance")])]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[e._v("ent prj ext-keycloak start\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[e._v("Start the microservice in another shell")])]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[e._v("ent prj be-test-run\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[e._v("Start the tableWidget MFE in a third shell")])]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[e._v("ent prj fe-test-run\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[e._v("When prompted to select a widget to run, choose the option corresponding to the tableWidget, e.g. "),a("code",[e._v("ui/widgets/conference/tableWidget")])])]),e._v(" "),a("h3",{attrs:{id:"step-3-access-the-tablewidget-mfe"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-3-access-the-tablewidget-mfe"}},[e._v("#")]),e._v(" Step 3: Access the tableWidget MFE")]),e._v(" "),a("ol",[a("li",[e._v("In your browser, go to "),a("a",{attrs:{href:"http://localhost:3000",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://localhost:3000"),a("OutboundLink")],1),e._v(". This is typically the location of the tableWidget MFE.")]),e._v(" "),a("li",[e._v("Access the tableWidget MFE with the default credentials of "),a("code",[e._v("username: admin")]),e._v(", "),a("code",[e._v("password: admin")])])]),e._v(" "),a("blockquote",[a("p",[e._v('Note: Once authenticated, the message "No conferences are available" is generated. If you check your browser\nconsole, you should see a '),a("code",[e._v("403 (Forbidden)")]),e._v(" error for the request made to "),a("code",[e._v("localhost:8080/services/conference/api/conferences")]),e._v(". This is expected because the admin user has not yet been granted the new role.")])]),e._v(" "),a("h3",{attrs:{id:"step-4-login-to-keycloak"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-4-login-to-keycloak"}},[e._v("#")]),e._v(" Step 4: Login to Keycloak")]),e._v(" "),a("ol",[a("li",[e._v("Go to "),a("a",{attrs:{href:"http://localhost:9080",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://localhost:9080"),a("OutboundLink")],1)]),e._v(" "),a("li",[e._v("Login using the the default credentials of "),a("code",[e._v("username: admin")]),e._v(", "),a("code",[e._v("password: admin")])])]),e._v(" "),a("h3",{attrs:{id:"step-5-create-the-conference-user-and-conference-admin-roles"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-5-create-the-conference-user-and-conference-admin-roles"}},[e._v("#")]),e._v(" Step 5: Create the "),a("code",[e._v("conference-user")]),e._v(" and "),a("code",[e._v("conference-admin")]),e._v(" roles")]),e._v(" "),a("p",[e._v("Add the "),a("code",[e._v("conference-user")]),e._v(" and "),a("code",[e._v("conference-admin")]),e._v(" roles to the "),a("code",[e._v("internal")]),e._v(" client.")]),e._v(" "),a("ol",[a("li",[e._v("Go to "),a("code",[e._v("Clients")]),e._v(" → "),a("code",[e._v("internal")]),e._v(" → "),a("code",[e._v("Roles")])]),e._v(" "),a("li",[e._v("Click "),a("code",[e._v("Add Role")])]),e._v(" "),a("li",[e._v("Fill in the "),a("code",[e._v("Role Name")]),e._v(" with "),a("code",[e._v("conference-admin")])]),e._v(" "),a("li",[e._v("Click "),a("code",[e._v("Save")])]),e._v(" "),a("li",[e._v("Repeat these steps to create the "),a("code",[e._v("conference-user")]),e._v(" role")])]),e._v(" "),a("blockquote",[a("p",[e._v("Note: The "),a("code",[e._v("internal")]),e._v(" client is configured by default in the Spring Boot "),a("code",[e._v("application.yml")]),e._v(".")])]),e._v(" "),a("h3",{attrs:{id:"step-6-map-the-conference-user-role-to-the-admin-user"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-6-map-the-conference-user-role-to-the-admin-user"}},[e._v("#")]),e._v(" Step 6: Map the "),a("code",[e._v("conference-user")]),e._v(" role to the admin user")]),e._v(" "),a("p",[e._v("To grant access to the "),a("code",[e._v("getAllConferences")]),e._v(" API:")]),e._v(" "),a("ol",[a("li",[e._v("Go to "),a("code",[e._v("Users")]),e._v(" → "),a("code",[e._v("View all users")]),e._v(" → "),a("code",[e._v("admin")]),e._v(" → "),a("code",[e._v("Role Mappings")])]),e._v(" "),a("li",[e._v("Select "),a("code",[e._v("internal")]),e._v(" for the "),a("code",[e._v("Client Roles")])]),e._v(" "),a("li",[e._v("Move "),a("code",[e._v("conference-user")]),e._v(" from "),a("code",[e._v("Available Roles")]),e._v(" to "),a("code",[e._v("Assigned Roles")])]),e._v(" "),a("li",[e._v("Return to the MFE to confirm you see the full list of Conferences")])]),e._v(" "),a("h3",{attrs:{id:"step-7-restrict-the-ability-to-delete-conferences"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-7-restrict-the-ability-to-delete-conferences"}},[e._v("#")]),e._v(" Step 7: Restrict the ability to delete Conferences")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("conference-admin")]),e._v(" role should grant a user permission to delete Conferences. To restrict the delete method to the "),a("code",[e._v("conference-admin")]),e._v(" role:")]),e._v(" "),a("ol",[a("li",[e._v("Go to the "),a("code",[e._v("src/main/java/com/YOUR-ORG/YOUR-NAME/web/rest")]),e._v(" directory")]),e._v(" "),a("li",[e._v("Open "),a("code",[e._v("ConferenceResource.java")])]),e._v(" "),a("li",[e._v("Modify the "),a("code",[e._v("deleteConference")]),e._v(" method by preceding it with the following annotation:")])]),e._v(" "),a("div",{staticClass:"language-java extra-class"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[e._v(" ")]),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[e._v("    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[e._v("@PreAuthorize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("\"hasAuthority('conference-admin')\"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("public")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("ResponseEntity")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Void")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("deleteConference")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[e._v("@PathVariable")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Long")]),e._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])])]),a("p",[e._v("To verify that a user without the "),a("code",[e._v("conference-admin")]),e._v(" role is unable to call the delete API:")]),e._v(" "),a("ol",[a("li",[e._v("Restart the microservice. By default this includes rebuilding any changed source files.")]),e._v(" "),a("li",[e._v("Once the microservice is available, return to the MFE and try deleting one of the Conferences in the list")]),e._v(" "),a("li",[e._v("Verify that attempting to delete via the UI generates a "),a("code",[e._v("403 error")]),e._v(" in the browser console and an error in the service logs similar to the following:")])]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("WARN 3208 --- [  XNIO-1 task-3] o.z.problem.spring.common.AdviceTraits   : Forbidden: Access is denied\n")])])]),a("h3",{attrs:{id:"step-8-hide-the-delete-button"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-8-hide-the-delete-button"}},[e._v("#")]),e._v(" Step 8: Hide the delete button")]),e._v(" "),a("p",[e._v("The MFE UI can be updated to hide the delete button from a user without the "),a("code",[e._v("conference-admin")]),e._v(" authority. The key logic checks whether the "),a("code",[e._v("internal")]),e._v(" client role "),a("code",[e._v("conference-admin")]),e._v(" is mapped to the current user via the hasResourceRole call.")]),e._v(" "),a("ol",[a("li",[e._v("Go to the "),a("code",[e._v("ui/widgets/conference/tableWidget/src/components")]),e._v(" directory")]),e._v(" "),a("li",[e._v("Open "),a("code",[e._v("ConferenceTableContainer.js")])]),e._v(" "),a("li",[e._v("Replace the "),a("code",[e._v("onDelete")]),e._v(" logic with an additional user permission:")])]),e._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[e._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" isAdmin "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("keycloak "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("&&")]),e._v(" keycloak"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("authenticated"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("?")]),e._v(" keycloak"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("hasResourceRole")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"conference-admin"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"internal"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" showDelete "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" onDelete "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("&&")]),e._v(" isAdmin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[e._v("Actions")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" item "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v("\n      showDelete "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("?")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[e._v("Confirm that the delete icon is no longer visible in the MFE. The MFE should have automatically reloaded to reflect the code changes.")])]),e._v(" "),a("h3",{attrs:{id:"step-9-grant-and-verify-delete-permissions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-9-grant-and-verify-delete-permissions"}},[e._v("#")]),e._v(" Step 9: Grant and verify delete permissions")]),e._v(" "),a("p",[e._v("Promote the admin user to a full "),a("code",[e._v("conference-admin")]),e._v(" to reinstate the ability to delete Conferences.")]),e._v(" "),a("ol",[a("li",[e._v("Return to Keycloak at "),a("a",{attrs:{href:"http://localhost:9080",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://localhost:9080"),a("OutboundLink")],1)]),e._v(" "),a("li",[e._v("Go to "),a("code",[e._v("Users")]),e._v(" → "),a("code",[e._v("View all users")]),e._v(" → "),a("code",[e._v("admin")]),e._v(" → "),a("code",[e._v("Role Mappings")])]),e._v(" "),a("li",[e._v("Give the user the "),a("code",[e._v("conference-admin")]),e._v(" role")]),e._v(" "),a("li",[e._v("Reload the MFE")]),e._v(" "),a("li",[e._v("Confirm the delete icon is visible")]),e._v(" "),a("li",[e._v("Confirm a Conference can be successfully deleted from the list")])]),e._v(" "),a("h2",{attrs:{id:"notes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#notes"}},[e._v("#")]),e._v(" Notes")]),e._v(" "),a("h3",{attrs:{id:"realm-roles-versus-client-authorities"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#realm-roles-versus-client-authorities"}},[e._v("#")]),e._v(" Realm Roles versus Client Authorities")]),e._v(" "),a("p",[e._v("This tutorial utilizes authorities. In Keycloak, authorities are roles mapped to a user for a specific client. It is possible to assign higher-level Realm Roles directly to users, e.g. "),a("code",[e._v("ROLE_ADMIN")]),e._v(", but this can result in collisions between applications using the same roles.")]),e._v(" "),a("p",[e._v("To implement Realm-assigned roles, the code above must be modified:")]),e._v(" "),a("ul",[a("li",[e._v("In the backend, use the annotation "),a("code",[e._v("@Secured('ROLE_ADMIN)")]),e._v(" or "),a("code",[e._v("@PreAuthorize(hasRole('ROLE_ADMIN'))")])]),e._v(" "),a("li",[e._v("In the frontend, use "),a("code",[e._v("keycloak.hasRealmRole")]),e._v(" instead of "),a("code",[e._v("keycloak.hasResourceRole")])])]),e._v(" "),a("p",[e._v("See the "),a("a",{attrs:{href:"https://www.baeldung.com/spring-security-check-user-role",target:"_blank",rel:"noopener noreferrer"}},[e._v("Spring Security page"),a("OutboundLink")],1),e._v(" for more examples.")]),e._v(" "),a("h3",{attrs:{id:"local-vs-kubernetes-testing"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#local-vs-kubernetes-testing"}},[e._v("#")]),e._v(" Local vs. Kubernetes Testing")]),e._v(" "),a("p",[e._v("This tutorial leverages the "),a("code",[e._v("internal")]),e._v(" client, which is configured in the microservice via the "),a("code",[e._v("application.yml")]),e._v(". Client roles are manually created and assigned in Keycloak.")]),e._v(" "),a("p",[e._v("In Kubernetes, Entando will automatically create client roles per the bundle plugin definition (see the "),a("RouterLink",{attrs:{to:"/v7.0/docs/curate/ecr-bundle-details.html"}},[e._v("plugin definition")]),e._v(" for more information). These roles are created for the client specific to the microservice, e.g. "),a("code",[e._v("<docker username>-conference-server")]),e._v(". The client name is injected as an environment variable into the plugin container, so the annotations noted above will work in both local and Kubernetes environments.")],1),e._v(" "),a("h4",{attrs:{id:"modify-security-checks-for-kubernetes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#modify-security-checks-for-kubernetes"}},[e._v("#")]),e._v(" Modify Security Checks for Kubernetes")]),e._v(" "),a("p",[e._v("In this tutorial, the MFE authorization checks explicitly note the client ID,  e.g. "),a("code",[e._v("internal")]),e._v(". The following options modify the checks to work in Kubernetes:")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("Change the "),a("code",[e._v("application.yml")]),e._v(" client ID under "),a("code",[e._v("security.oauth2.client.registration.oidc")]),e._v(" to match the Kubernetes client ID.")]),e._v(" "),a("p",[e._v("This is the most secure option and allows the MFE checks to work identically in both local and Kubernetes environments. However, you may not be be able to use the same clientId, depending on how the microservice is deployed.")])]),e._v(" "),a("li",[a("p",[e._v("Broaden the MFE authorization check to look for a named role on any client.")]),e._v(" "),a("p",[e._v("This could result in overlap with other clients, but this is the most flexible option when using appropriately named roles (e.g. with a bundle or feature prefix like "),a("code",[e._v("conference-")]),e._v(" in "),a("code",[e._v("conference-admin")]),e._v("). It can be achieved via a helper function, e.g. "),a("code",[e._v("api/helpers.js")]),e._v(", and results in a simpler role check:")])])]),e._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Add helper function")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Check if the authenticated user has the clientRole for any Keycloak clients")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[e._v("hasKeycloakClientRole")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("clientRole")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("getKeycloakToken")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" resourceAccess "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("entando"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("keycloak"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("resourceAccess"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" client "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("in")]),e._v(" resourceAccess"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// eslint-disable-line no-unused-vars")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" roles "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" resourceAccess"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("roles"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("roles "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("&&")]),e._v(" roles"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("includes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("clientRole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Perform role check")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" isAdmin "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("hasKeycloakClientRole")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'conference-admin'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("h3",{attrs:{id:"troubleshooting"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#troubleshooting"}},[e._v("#")]),e._v(" Troubleshooting")]),e._v(" "),a("p",[e._v("In both local and Kubernetes environments, the default Blueprint Javascript provides a global variable in the browser, e.g. "),a("code",[e._v("window.entando.keycloak")]),e._v(". Examining this variable can help diagnose issues with assigned roles and authorities. In some cases, you may need to logout of Entando and reauthenticate for the latest role assignments to be applied.")])])}),[],!1,null,null,null);t.default=n.exports}}]);