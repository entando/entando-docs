= CREATING A PLUGIN - BACK END 

:sectnums:
:sectanchors:
:imagesdir: images/

== INTRODUCTION
This section introduces how to create a plugin for Entando 5.x and how to integrate it with the App Builder. The following paragraphs explain how to create the back end of the plugin. <<plugincyclesample_front-end,Click here>> for steps on creating the front end of the plugin to integrate with the App Builder.

[[plugincyclesample_back-end]]
== INITIALIZE THE ENVIRONMENT
The first step is to create a root directory for your application.

Once you have a root directory, download and install the necessary projects from the https://github.com/entando/[Entando github repository] into your project’s root folder. There are three required projects: entando-core, entando-components, and entando-archetypes. Complete the following steps three times: once for each of the necessary projects.

.Complete the following steps IN ORDER:

. From your root directory, clone the project through the shell command: +
`git clone https://github.com/entando/entando-<PROJECT_SUFFIX>.git`
. Navigate to the newly created folder.
. Open the _pom.xml_ file and note the current project version. You will need this version number later. Example: +
`<version>5.1.0-SNAPSHOT</version>`
. Run the following command: +
`mvn clean install -DskipTests`
. Return to your root directory and re-run the steps for the next Entando project.

== CREATE AN ENTANDO PROJECT
The following sections are for creating a new Entando project. If you already have the project set up, skip to the Add the Plugin to the Entando Project section.

. Open the command line from your workspace folder.
. Run the command: +
`mvn archetype:generate -Dfilter=entando`
. On the project type selection screen, choose the number corresponding to "org.entando.entando:entando-archetype-entando-sample".
. Select the version that corresponds to the version number you noted in the Initialize the Environment section.
** If that option is not available, take the following steps: +
... Navigate to your computer’s home directory and open the folder titled _.m2_.
... Copy the file named _archetype-catalog.xml_ and paste it into your Entando project folder.
... Restart the steps in this section.
. For "groupId" enter `org.entando` (or the groupId of your company) and press *ENTER*.
. For "artifactId", enter the name of the project and press *ENTER*.
. For "version" leave the selection blank and press *ENTER*.
. For "package" leave the selection blank and press *ENTER*
. In the configuration confirmation interface, type `Y` and press *ENTER*. You have now created your Entando project.

== CREATE A CUSTOM COMPONENT PROJECT
Now, create an empty component project that reflects the entando-component structure present on GitHub. The project will serve as a container for the plugin that you are creating here.

. Clone and rename the project entando-components from https://github.com/entando/entando-components. Example of shell command: +
`git clone https://github.com/entando/entando-components.git [new-project-name]`

. Open the plugins folder and delete all folders except the _src_ folder.
. Open _plugins/pom.xml_ and delete all module instances within the <modules> element.
+
image::pcbe_modules.png[]
. Open the the _ui-bundles_ folder and delete all the subfolders.
+
image::pcbe_uibundles.png[]

. Open _ui-bundles/pom.xml_ and delete all module instances within the <modules> element.

== CREATE A PROTOTYPE PLUGIN CALLED "PHONEBOOK"
This step creates the basic structure of the plugin, on which all the resources generated by EDO will subsequently be inserted.

. Open the _entando-components/plugins_ folder on your command line.
. Run the command: +
`mvn archetype:generate -Dfilter=entando`

. In the project type selection screen, choose the number corresponding to "org.entando.entando: entando-archetype-plugin-generic".
. Select the version number you noted in Initialize the Environment, Step 3.
.. If that option is not available, take the following steps:
... Navigate to your computer’s home directory and open the folder titled _.m2_.
... Copy the file named _archetype-catalog.xml_ and paste it into the _Repository_ folder.
... Restart the steps in this section.
. For "groupId" enter "org.entando.entando.plugins".
. For "artifactId" enter "entando-plugin-jpphonebook" and press *ENTER*.
. For "version" leave the selection blank and press *ENTER*.
. For "package" leave the selection blank and press *ENTER*.
. For the configuration confirmation interface, type 'N' and press *ENTER*. +
=====
NOTE: The ‘N’ response is necessary to enter the part of the workflow that allows you to input new parameters for pluginCode (pre-set to "jpchangeme") and pluginName (pre-set to "Please Change Me")
=====
[start=10]
. Repeat steps 5 through 8.
. For "pluginCode" enter "jpphonebook" and press *ENTER*.
. For "pluginName" enter "Phone Book Plugin - Full Lifecycle Sample" and press *ENTER*.
. In the configuration confirmation interface, press *ENTER*. This creates the plugin skeleton in a new folder called _entando-components/plugins/entando-plugin-jpphonebook_.
+
image::pcbe_jpphonebook.png[]

== CREATE PLUGIN WITH EDO (COMPONENT GENERATOR)
EDO is the official code generator tool for Entando.

. Follow the instructions at https://github.com/entando/component-generator to build the necessary EDO jar.
. Clone the project to the root of your own workspace: +
`git clone https://github.com/entando/component-generator.git`
. Open the new _component-generator_ folder and run the following command from the command line: +
`ant build`
. Open the _target_ folder and copy _edo-5.x.x-SNAPSHOT.jar_ into the _entando-components-sample/plugins/entando-plugin-jpphonebook_ that you created in Step 13 of the Create a Prototype Plugin Called “Phonebook" section.
. Define the structure of the object that the plugin will manage. For example, the plugin has to manage the "Contact" object consisting of the follow fields:
** "firstname" - type "String" - required - max length 50 characters
** "surname" - type "String" - required - max length 50 characters
** "birthDate" - type "Date" - not required
** "description" - type "String" - not required
** "phoneNumber" - type "String" - required
** "priority" - type "Integer" - not required
. Save the following JSON string as a new file called _edo-full_lifecycle_sample.json_. This is the first step in creating a JSON file that EDO requires to create the resources. +
....
{
    "packageName" : "org.entando.entando.plugins.jpphonebook",
    "model" : {
    "name" : "Contact",
    "fields" : [ {
      "name" : "firstname",
      "type" : "string",
      "required" : true,
      "length" : 50,
      "primaryKey" : false
    }, {
      "name" : "surname",
      "type" : "string",
      "required" : true,
      "length" : 50,
      "primaryKey" : false
    }, {
      "name" : "bornDate",
      "type" : "date",
      "required" : false,
      "length" : null,
      "primaryKey" : false
    }, {
      "name" : "description",
      "type" : "string",
      "required" : false,
      "length" : null,
      "primaryKey" : false
    }, {
      "name" : "phoneNumber",
      "type" : "string",
      "required" : true,
      "length" : null,
      "primaryKey" : false
    }, {
      "name" : "priority",
      "type" : "int",
      "required" : false,
      "length" : null,
      "primaryKey" : false
    } ]
  },
  "assets" : {
    "rest" : true,
    "cxf" : true,
    "specialWidget" : true,
    "internalServlet" : true,
    "adminConsole" : true,
    "adminConsoleProducer" : null
  }
}
....
[start=7]
. Open the _entando-components-sample/plugins/entando-plugin-jpphonebook_ folder from the command line and run the following command: +
`java -jar edo-5.1.0-SNAPSHOT.jar -f edo-full_lifecycle_sample.json`
. Address duplicate file warnings from the console by removing the empty files created by the archetype and replacing them with those created by EDO.
** component.xml file
... Delete the file _src/main/resources/component/plugins/jpphonebook/component.xml_
... Rename the file _src/main/resources/component/plugins/jpphonebook/change_me-component.xml_ to _src/main/resources/component/plugins/jpphonebook/component.xml_
... Open the _component.xml_ file and rename the content of element "description" to _Phone Book Plugin - Full Lifecycle Sample_
... Fix the default resources (sql script) associated with the component descriptor (component.xml file) of the plugin _entando-plugin-jpphonebook_
** Open the folder _src/main/resources/sql/plugins/jpphonebook/_
... Delete files the following files:
**** _port_data_production.sql_
**** _serv_data_production.sql_
**** _port_uninstallation.sql_
**** _serv_uninstallation.sql_
... Rename the following files:
**** _change_me-port_data_production.sql_ to _port_data_production.sql_
**** _change_me-serv_data_production.sql_ to _serv_data_production.sql_
... Adjust the default test resources (sql script) associated with the component descriptor (component.xml file) of the plugin _entando-plugin-jpphonebook_.
**** Open the folder _src/test/resources/sql/plugins/jpphonebook_
**** Delete files _port_data_test.sql_ and _serv_data_test.sql_
**** Rename the following files:
***** _change_me-port_data_test.sql_ to _port_data_test.sql_
***** _change_me-serv_data_test.sql_ to _serv_data_test.sql_
... Adjust the definition of Struts2 actions associated with the component of the plugin _entando-plugin-jpphonebook_.
**** Open the folder _src/main/resources_
**** Delete file _entando-struts-plugin.xml_.
**** Rename _change_me-jpphonebook-contact-struts-plugin.xml_ to _entando-struts-plugin.xml_
Upon completion, the plugin is ready for you to install and insert into an Entando project.
=====
IMPORTANT: For best performance, the plugin version *must* match the version of the Entando project you add it to.
=====

== INSTALL THE NEW PLUGIN COMPONENT
From the command line, open the _entando-components-sample_ folder and run the following command: +
`mvn clean install -DskipTests`


At the end of the process you should see the following message, indicating a successful install:

image::pcbe_successfulinstall.png[]

== ADD THE PLUGIN TO AN ENTANDO PROJECT
Open the pom.xml file of your project and insert the following snippet to the end inside the element:
....
<dependency>
    <groupId>org.entando.entando.plugins</groupId>
    <artifactId>entando-plugin-jpphonebook</artifactId>
    <version>${entando.version}</version>
    <type>war</type>
</dependency>
....

== APP BUILDER COMPONENT
The App Builder provides a user interface for managing the admin functions of the plugin. Therefore, the MApp Engine needs to expose services for the functions that plugins require. In the case of the Phonebook plugin, the MApp Engine must expose:

* APIs for CRUD operations on the Contact object. These APIs are available at the following endpoints:
** GET List of contacts - URI "<APPLICATION_BASE_URL>/api/jpphonebook/contacts" (GET)
** get single contact - URI "<APPLICATION_BASE_URL>/api/jpphonebook/contacts/{contactId}" (GET)
** add single contact - URI "<APPLICATION_BASE_URL>/api/jpphonebook/contacts" (POST)
** update single contact - URI "<APPLICATION_BASE_URL>/api/jpphonebook/contacts/{contactId}" (PUT)
** delete single contact - URI "<APPLICATION_BASE_URL>/api/jpphonebook/contacts/{contactId}" (DELETE)
* The API for configuring the _Publish Contact_ widget, which is the only EDO-generated widget that needs configuration. EDO provides the APIs that you need to create this UI but you must first custom develop and add a component for the validation. The validator is a bean class that extends the _WidgetConfigurationValidator_ class.
+
In the case of the Phonebook plugin, the following is the _ContactPublisherWidgetValidator_ class to include in the _org.entando.entando.plugins.jpphonebook.aps.system.services.contact.widgettype.validators package_:
....
package
org.entando.entando.plugins.jpphonebook.aps.system.services.contact.widgettype.validators;

import com.agiletec.aps.system.exception.ApsSystemException;
import com.agiletec.aps.system.services.page.IPage;
import java.util.Map;
import org.apache.commons.lang3.StringUtils;
import org.entando.entando.aps.system.exception.RestServerError;
import org.entando.entando.aps.system.services.widgettype.validators.WidgetConfigurationValidator;
import org.entando.entando.plugins.jpphonebook.aps.system.services.contact.IContactManager;
import org.entando.entando.web.page.model.WidgetConfigurationRequest;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.validation.BeanPropertyBindingResult;

public class ContactPublisherWidgetValidator implements WidgetConfigurationValidator {

    private final Logger logger = LoggerFactory.getLogger(this.getClass());

    public static final String WIDGET_CODE = "jpphonebookContact";
    public static final String WIDGET_CONFIG_KEY_CONTACT_ID = "id";

    public static final String ERRCODE_CONTACT_ID_NULL = "1";
    public static final String ERRCODE_CONTACT_ID_INVALID = "2";

    private IContactManager contactManager;

    @Override
    public boolean supports(String widgetCode) {
        return WIDGET_CODE.equals(widgetCode);
    }

    @Override
    public BeanPropertyBindingResult validate(WidgetConfigurationRequest widget, IPage page) {
        BeanPropertyBindingResult bindingResult = new BeanPropertyBindingResult(widget, widget.getClass().getSimpleName());
        Map<String, Object> properties = (Map<String, Object>) widget.getConfig();
        String contactIdString = (null != properties) ? properties.get(WIDGET_CONFIG_KEY_CONTACT_ID).toString() : null;
        try {
            logger.debug("validating widget {} for page {}", widget.getCode(), page.getCode());
            if (StringUtils.isBlank(contactIdString)) {
                bindingResult.reject(ERRCODE_CONTACT_ID_NULL, new String[]{}, "Contact id is required");
                return bindingResult;
            }
            Integer contactId = Integer.parseInt(contactIdString);
            if (null == this.getContactManager().getContact(contactId)) {
                bindingResult.reject(ERRCODE_CONTACT_ID_INVALID, new String[]{"Contact", contactIdString}, "NOT_FOUND");
                return bindingResult;
            }
        } catch (NumberFormatException e) {
            bindingResult.reject(ERRCODE_CONTACT_ID_INVALID, new String[]{}, "Contact id is required");
        } catch (ApsSystemException e) {
            logger.error("error in validate wiget {} in page {}", widget.getCode(), page.getCode());
            throw new RestServerError("error in widget config validation", e);
        }
        return bindingResult;
    }

    protected IContactManager getContactManager() {
        return contactManager;
    }

    public void setContactManager(IContactManager contactManager) {
        this.contactManager = contactManager;
    }
}
....

Insert the following bean definition into the file _full-lifecycle-sample/entando-components-sample/plugins/entando-plugin-jpphonebook/src/main/resources/spring/plugins/jpphonebook/aps/managers/jpphonebookContactManagersConfig.xml_
`<bean id="jpphonebookContactPublisherWidgetValidator" class="org.entando.entando.plugins.jpphonebook.aps.system.services.contact.widgettype.validators.ContactPublisherWidgetValidator">
<property name="contactManager" ref="jpphonebookContactManager" />
</bean>`
